\section{Response theory} \label{se:res}
Response theory combines adiabatic perturbation theory with a Fourier transform of the 
time-dependent equations into the frequency domain\cite{Barron2004,Pedersen2021}. 
The prediction of the response of molecular systems to an electromagnetic field (EMF) has 
important applications in organic synthesis and characterization. To explore these 
effects, we may relate properties to a perturbative expansion of a total electric or 
magnetic multipole moment, from which response tensors related to a host of properties 
may be defined. 
These response tensors generally take the form of products of ground- and excited-state 
transition moments of the electric or magnetic dipole operator. In this chapter we will 
summarize the derivation of these response tensors and their relationships to field-induced 
molecular phenomena. We then present a method for obtaining these tensors through Fourier 
transform of a time-dependent quasi-energy
\cite{Christiansen1998,Norman2011,Helgaker2012}
which is rigorously defined in the context of 
electronic structure theory, providing working equations for predicting molecular responses 
to EMF using approximate wave function-based theory.

\subsection{Exact Response} \label{ss:exact}
Under classical electrodynamics, the potential energy $V$ of a system of charges in a static electric field 
may be written in a multipole expansion:\cite{Barron2004}
\begin{equation} \label{eq:pot_V}
V = q(\phi)_O - \mu_\alpha(E_\alpha)_O - \frac{1}{3}\Theta_{\alpha\beta}(E_{\alpha\beta})_O + \ldots
\end{equation}
with the scalar potential $\phi$, 
the Cartesian component $\alpha$ of the electric field $E_\alpha$, and 
the electric field gradient with respect to two Cartesian coordinates $E_{\alpha\beta}$. 
Here we have defined the multipoles as the electric monopole or charge $q$, the electric dipole $\mu_\alpha$, and the electric quadrupole $\Theta_{\alpha\beta}$. 
The subscript $O$ indicates that the potential, field, or gradient is taken at the system origin.
We may also expand the potential in a Taylor series about the potential evaluated at zero field:
\begin{equation} \label{eq:tay_V}
    V[E_O] = V_O + (E_\alpha)_O\frac{\partial V}{\partial (E_\alpha)_O}\Bigr|_0 + \frac{1}{2}(E_\alpha)_O(E_\beta)_O\frac{\partial V^2}{\partial (E_\alpha)_O \partial (E_\beta)_O}\Bigr|_0 + \ldots
\end{equation}
From Eq.~(\ref{eq:pot_V}), we see that a Cartesian component of the electric dipole may be written as the derivative of the potential with respect to the field, 
\begin{equation} \label{eq:mu_part}
    \mu_\alpha = -\frac{\partial V}{\partial (E_\alpha)_O}\Bigr|_0.
\end{equation}
By comparing Eqs.~(\ref{eq:tay_V}) and (\ref{eq:mu_part}), we see that the total electric dipole may be re-written 
\begin{equation} \label{eq:mu_tot}
\mu_\alpha = \mu_{O\alpha} + \alpha_{\alpha\beta}(E_\beta)_O + \frac{1}{2}\beta_{\alpha\beta\gamma}(E_\beta)_O(E_\gamma)_O + \ldots
\end{equation}
where we have defined the response tensors for the permanent (field-independent) dipole moment $\mu_{0\alpha}$, electric polarizability $\alpha_{\alpha\beta}$, first electric hyperpolarizability $\beta_{\alpha\beta\gamma}$, and higher order terms as higher-order derivatives of the potential, \textit{viz.}
\begin{subequations} \label{eq:derivs}
    \begin{equation} \label{eq:mu_0}
    \mu_{0\alpha} = -\frac{\partial V}{\partial (E_\alpha)_O}\Bigr|_0
    \end{equation}

    \begin{equation} \label{eq:alpha}
    \alpha_{\alpha\beta} = -\frac{\partial^2 V}{\partial (E_\alpha)_O \partial (E_\beta)_O}\Bigr|_0
    \end{equation}

    \begin{equation} \label{eq:beta}
    \beta_{\alpha\beta\gamma} = -\frac{\partial^3 V}{\partial (E_\alpha)_O \partial (E_\beta)_O \partial (E_\gamma)_O}\Bigr|_0.
    \end{equation}
\end{subequations}
Property tensors for magnetic and mixed electric-magnetic properties, as well as higher-order
multipoles in Eq.~(\ref{eq:pot_V}), are defined in an 
analogous manner.\cite{Barron2004} 

Quantum mechanical expressions for the property tensors may be obtained through perturbation theory. 
For static-field properties, this process is straightforward, and expressions similar to those found for
correlation energy corrections in Eq.~({\ref{eq:E2}) arise in the perturbative expansion of the time-independent Schr\"odinger
equation, e.g., for the static polarizability tensor:
\begin{equation} \label{eq:static_pol}
\alpha_{\alpha\beta} = -2\sum_{j\neq 0}\frac{\bra{n}\mu_\alpha\ket{j}\bra{j}\mu_\beta\ket{n}}{V_n - V_j} 
\end{equation}
where the sum runs over excited-states $j$.

Of more practical application is the prediction of dynamic-field properties, such as dynamic polarizabilities, 
optical rotation, and circular dichroism (which are the primary targets of [PAPER1] and [PAPER3]).
For these and other time-dependent response properties, some description of the time evolution of the wave function is
required. 
These properties may be solved directly from the time-dependent analogue of Eq.~(\ref{eq:mu_tot}). 
To compute the now-time-dependent dipole, one must compute the dipole moment expectation value of a system 
in the presence of an explicitly time-dependent EMF.
Fourier transformation of the dynamic dipole (and the corresponding EMF terms) 
into the frequency domain produces a broadband spectrum.
However, explicit time propagation of the wave function is exceedingly expensive.\cite{Goings2018} 
This is the topic of [PAPER 3]. 
For now, we will consider an alternative approach utilizing time-depending perturbation 
theory. This approach avoids explicit propagation of the wave function, but limits our
application to individual frequencies, rather than broadband spectra. Nevertheless, 
some properties (such as optical rotation) are only experimentally measured at a select few
frequencies, and spectra may still be approximated by computing values at 
multiple frequencies. 

Beginning from the time-dependent Schr\"odinger equation,
\begin{equation} \label{eq:tdse}
    \hat{H}(t)\ket{\Psi(t)} = i\hbar\partt{}\ket{\Psi(t)}
\end{equation}
we will, without loss of generality, assume a time-dependent wave function expansion of the form
\begin{subequations} \label{eq:td_wfn}
    \begin{equation}
        \ket{\Psi(t)} = d_n(t)\ket{\psi_n(t)}
    \end{equation}
    \begin{equation}
        \ket{\psi_n(t)} = e^{-iE_nt/\hbar}\ket{n}
    \end{equation}
\end{subequations}
where $\ket{\psi(t)}$ is an approximate wave function consisting of a weighted sum of known, time-independent functions $\ket{n}$
and an exponentiated phase. Expressing the Hamiltonian as in Eq.~(\ref{eq:H}) as a sum of the time-independent molecular
Hamiltonian $\hat{H}^{(0)}$ with a time-dependent perturbation $\hat{V}(t)$
(generally taken to be an EMF) and inserting this and the wave function expansion into Eq.~({\ref{eq:tdse}) yields
\begin{equation} \label{eq:sub_tdse}
    (\hat{H}^{(0)} + \hat{V}(t))d_n(t)e^{-iE_nt/\hbar}\ket{n} = i\hbar \partt{}\left[d_n(t)e^{-iE_nt/\hbar}\right]\ket{n}.
\end{equation}
It should be noted that, in the absence of a perturbation (time $t = 0$), 
this reduces to the time-independent Schr\"odinger equation ($d_n(0) = 1$). 
Using the chain rule, Eq.~({\ref{eq:sub_tdse}}) becomes  
\begin{equation} \label{eq:chain_tdse}
    (\hat{H}^{(0)} + \hat{V}(t))d_n(t)e^{-iE_nt/\hbar}\ket{n} = \left[E_n d_n(t) + i\hbar \partt{d_n(t)}\right]e^{-iE_nt/\hbar}\ket{n}.
\end{equation}
If we assume we have \textit{exact} eigenstates $\ket{n}$ of the molecular Hamiltonian, 
\textit{i.e.} exact ground- and excited-state wave functions, 
then the first terms of both sides of Eq.~(\ref{eq:chain_tdse}) cancel. Projecting on the left by 
the excited-state $\bra{m}$ and rearranging, we arrive at the differential equation
\begin{equation} \label{eq:diffeq}
    \partt{d_m(t)} = \frac{1}{i\hbar}\sum_n\bra{m}\hat{V}(t)\ket{n}d_n(t)e^{i\omega_{mn} t}
\end{equation}
which describes the time evolution of the wave function coefficient $d_m(t)$. We have also introduced the angular 
frequency $\omega_{mn} = (E_m - E_n)/\hbar$ and included the explicit sum over excited states $\ket{n}$ for clarity. 

Integration of Eq.~(\ref{eq:diffeq}) from time $t' = 0$ to $t' = t$ yields a recursive equation for the 
wave function parameter $d_m(t)$, due to the presence of $d_n(t)$ on the right-hand side. 
However, as a consequence of our assumption that the system begins in its unperturbed ground-state, all
coefficients at $t' = 0$ reduce to $\delta_{n,0}$. To linear order in $\hat{V}$, Eq.~(\ref{eq:diffeq}) may be written
\begin{equation} \label{eq:irt}
    d_m(t) = \frac{1}{i\hbar}\int_0^t\bra{m}\hat{V}(t^{'})\ket{0}e^{i\omega_{m0}t^{'}}dt^{'}.
\end{equation}
%\begin{equation} \label{eq:irt}
%    \begin{aligned}
%    d_m(t') = 1 &+ \frac{1}{i\hbar}\int_0^t\bra{m}\hat{V}(t^{'})\ket{n}d_n(t^{'})e^{-i\omega_{mn}t^{'}}dt^{'} \\
%            = 1 &+ \frac{1}{i\hbar}\int_0^t\bra{m}\hat{V}(t^{'})\ket{n}e^{-i\omega_{mn}t^{'}}dt^{'} \\
%                &- \frac{1}{\hbar}\int_0^t\int_0^{t^{'}}\bra{m}\hat{V}(t^{'})\ket{l}\bra{l}\hat{V}(t^{''})\ket{n}e^{-i\omega_{ml}t^{'}}e^{-i\omega_{ln}t^{''}}dt^{''} \\
%                &+ \ldots
%    \end{aligned}
%\end{equation}

To continue, we choose our perturbation to be a simple, time-dependent field at a given frequency $\omega$ 
\begin{equation} \label{eq:field}
\hat{V}(t) = \hat{v}^\omega_\alpha F^\omega_\alpha e^{-i\omega t}
\end{equation}
with field strength $F^\omega_\alpha$ and arbitrary field operator $\hat{v}^\omega_\alpha$, such as the electric or magnetic dipole operator. 
Finally, inserting Eq.~(\ref{eq:field}) into Eq.~(\ref{eq:irt}) and integrating, we arrive at the final expression for the
wave function parameters
\begin{equation} \label{eq:sot}
    \begin{aligned}
        d_m(t) = \frac{1}{\hbar}\frac{\bra{m}\hat{v}^\omega_\alpha\ket{0}e^{i(\omega_{m0}-\omega)t}}{\hbar(\omega_{m0}-\omega)}F^{\omega}_{\alpha}.
%        d_m(t') = 1 &+ \frac{-1}{\hbar}\frac{\bra{m}\hat{v}^\omega_\alpha\ket{n}}{\omega_{mn} - \omega_1}e^{-i\omega_{mn}t}e^{-i\omega_1t} \\
%                &- \frac{1}{\hbar}\frac{\bra{m}\hat{v}^{\omega1}_\alpha\ket{l}\bra{l}\hat{v}^{\omega2}_\beta\ket{n}}{(\omega_{ml}-\omega_1)(\omega_{ln}-\omega_2)}e^{-i(\omega_{ml}-\omega_{ln})t}e^{-i(\omega_1-\omega_2)t} \\
%                &+ \ldots
    \end{aligned}
\end{equation}
 
To arrive at a dipole expression in the form of Eq.~(\ref{eq:mu_tot}), we may compute the expectation 
value of the electric dipole operator $\hat{\mu}$. After rearrangement, we arrive at
\begin{equation} \label{eq:sos}
    \begin{aligned}
    \bra{\Psi(t)}\hat\mu\ket{\Psi(t)} &= \bra{0}\hat\mu\ket{0} \\ 
    &- \sum_{m\neq0}\left[\frac{\bra{m}\hat\mu\ket{0}\bra{0}\hat{v}^\omega_\alpha\ket{m}}{\hbar(\omega_{mo}+\omega)}
        + \frac{\bra{0}\hat\mu\ket{m}\bra{m}\hat{v}^\omega_\alpha\ket{0}}{\hbar(\omega_{mo}-\omega)}\right]
    e^{-i\omega t}F^\omega_\alpha
    \end{aligned}
\end{equation}
where we have truncated at the linear response function of $\hat{\mu}$ perturbed by $\hat{V}(t)$. This is known as the \textit{exact} linear response function. In general, 
response functions can be identified by the expansion of an operator $\hat\Omega$:
\begin{equation}
    \begin{aligned}
    \bra{\Psi(t)}\hat\Omega\ket{\Psi(t)} &= \bra{0}\hat\Omega\ket{0} \\ 
    &+ \linresp{\hat\Omega}{\hat{v}^{\omega_1}_\alpha}e^{-i\omega_1 t}F^{\omega_1}_\alpha \\ 
    &+ \quadresp{\hat\Omega}{\hat{v}^{\omega_1}_\alpha}{\hat{v}^{\omega_2}_\beta}e^{-i(\omega_1+\omega_2)t}F^{\omega_1}_\alpha F^{\omega_2}_\beta \\
    &+ \ldots
    \end{aligned}
\end{equation}
where we have introduced notation for the linear $\linresp{\hat\Omega}{\hat{v}^{\omega_1}_\alpha}$ 
and quadratic $\quadresp{\hat\Omega}{\hat{v}^{\omega_1}_\alpha}{\hat{v}^{\omega_2}_\beta}$ response functions.

\subsection{Approximate Response} \label{ss:apprx} Sum-over-states expressions
like those in Eq.~(\ref{eq:sos}) can be solved by computing the excited-state
wave functions and summing their individual contributions to the property. This
poses a unique challenge in that the response tensor is not a product of only
one targeted excited-state, but of all possible excited-states. While it is
expected many high-energy states will have negligible contributions, the number
of states required to accurately model some properties such as optical rotation
makes this approach prohibitively expensive for excited-state extensions to
ground-state methods, such as equation-of-motion (EOM) CC.\cite{Wiberg2006}  
We can avoid this
problem by building response equations based on approximate ground-state wave
functions, such as Eq.~(\ref{eq:cc_TISE}). This eliminates the requirement of 
computing excited-state wave functions and allows us to replace the
sum-over-states expression with a set of coupled linear equations which are far
more computationally tractable.\cite{Norman2011,Helgaker2012}

Beginning with a time-dependent wave function $\ket{\Psi(t)}$, we may separate this into two time-dependent pieces - the exponential of a phase factor $\phi(t)$, and a phase-isolated wave function $\ket{\piw}$:
\begin{equation} \label{total_psi}
    \ket{\Psi(t)} = e^{-i\phi(t)}\ket{\piw}.
\end{equation}
We may require that the phase of the projection of $\ket{\piw}$ onto the ground-state wave function be 
zero - in other words, in the limit of zero time-dependent perturbation, $\ket{\piw}$ reduces to the
ground-state wave function. This is analogous to our approach in Eq.~(\ref{eq:td_wfn}), where our focus has
now shifted from the wave function parameters to the phase factor.
Inserting these definitions into the time-dependent Schr\"odinger equation,
we arrive at Eq.~(\ref{eq:quasi_schro}):
\begin{equation} \label{eq:quasi_schro}
    (\hat{H} - i\hbar \partt{})\ket{\piw} = Q(t)\ket{\piw}
\end{equation}
where we have defined the time-dependent quasi-energy as the reduced Planck constant times the derivative
of the phase factor,
\begin{equation} \label{eq:quasi_e}
    Q(t) = \hbar\partt{\phi(t)}.
\end{equation}
It is important to note that, just as the phase-isolated wave function reduces to the ground-state wave function in the absence of a perturbation, the quasi-energy also reduces to the ground-state energy in this case. 

It can be shown that the quasi-energy is manifestly real, and both a time-dependent variational 
principle and Hellmann-Feynman theorem apply.\cite{Norman2011} To obtain a time-independent 
quantity to perturbatively expand, the quasi-energy is integrated over time to form the 
time-averaged quasi-energy $Q_T$. The variational and Hellmann-Feynman theorems can then be written
\begin{equation} \label{eq:var}
    \partial Q_T = 0
\end{equation}
and
\begin{equation} \label{eq:hf-theorem}
    \frac{dQ_T}{d\hat\Omega} = \frac{1}{T}\int_{t^{'}}^{t^{'}+T}\bra{\piw}\frac{\partial \hat{H}}{\partial\hat\Omega}\ket{\piw}dt^{'},
\end{equation}
respectively, for an arbitrary perturbation $\hat\Omega$ (usually taken to be an 
electromagnetic field). Thus, the quasi-energy is a well-defined dynamic analogue to the
electronic energy. 

In the preceding derivation, at no point was it assumed that we have \textit{exact} eigenfunctions 
of the time-independent Hamiltonian. Thus, the above equations are valid for approximate 
ground-state theories, such as CC. We may now define our approximate response functions as we did 
in Eq.~(\ref{eq:derivs}) as derivatives of this time-averaged quasi-energy,
\begin{subequations}
    \begin{equation}
        \linresp{\hat\Omega}{\hat v^{\omega_1}_{\alpha}} = \frac{d^2Q_T}{d\hat\Omega dF^{\omega_1}_\alpha}
    \end{equation}
    \begin{equation}
        \quadresp{\hat\Omega}{\hat{v}^{\omega_1}_\alpha}{\hat{v}^{\omega_2}_\beta} = \frac{d^3Q_T}{d\hat\Omega dF^{\omega_1}_\alpha dF^{\omega_2}_\beta}
    \end{equation}
\end{subequations}
and working equations may be derived by inserting the specific approximate wave function ansatz.

The response functions of interest to the present work are the linear response functions between 
the electric dipole and an electric field
$\linresp{\hat\mu}{\hat{\mu}}$,
and the magnetic dipole in an electric field
$\linresp{\hat m}{\hat{\mu}}$. 
These are responsible for the dynamic electric polarizability and chiroptical response (optical
rotation and circular dichroism) respectively.\cite{Helgaker2012} 
The latter constitutes a long-standing challenge
for response theory,\cite{Crawford2007,Crawford2019} 
requiring mixed electric- and magnetic-field derivatives and 
leaving minimal room for error, but is also a 
prime candidate for comparisons to experiment. Some limitations of and alternatives to response
theory will be explored in chapters [PAPER 1] and [PAPER 3].
